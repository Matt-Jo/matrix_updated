<?php
require_once(__DIR__.'/../../includes/application_top.php');

prepared_query::execute("UPDATE acc_invoices i JOIN (SELECT i.invoice_id, GREATEST(IFNULL(it.invoice_total_price, 0) - IFNULL(SUM(pti.credit_amount), 0), 0) as invoice_balance FROM acc_invoices i LEFT JOIN acc_invoice_totals it ON i.invoice_id = it.invoice_id AND it.invoice_total_line_type = 'ot_total' LEFT JOIN acc_payments_to_invoices pti ON i.invoice_id = pti.invoice_id WHERE i.inv_order_id IS NOT NULL AND i.paid_in_full = 0 GROUP BY i.invoice_id HAVING invoice_balance <= 0) b ON i.invoice_id = b.invoice_id SET i.paid_in_full = 1 WHERE i.inv_order_id IS NOT NULL AND i.paid_in_full = 0 AND b.invoice_balance <= 0");

prepared_query::execute('INSERT INTO ck_daily_ar_aging_snapshot (snapshot_date, balance_total, late_balance_total, current, late_1_to_15, late_16_to_30, late_31_to_60, late_61_plus, credits_total, credits_with_balance, credits_no_balance) SELECT NOW() as snapshot_date, IFNULL(SUM(i.invoice_balance), 0) as balance_total, IFNULL(SUM(IF(i.invoice_days_late > 0, i.invoice_balance, 0)), 0) as late_balance_total, IFNULL(SUM(IF(i.invoice_days_late <= 0, i.invoice_balance, 0)), 0) as current, IFNULL(SUM(IF(i.invoice_days_late > 0 AND i.invoice_days_late <= 15, i.invoice_balance, 0)), 0) as late_1_to_15, IFNULL(SUM(IF(i.invoice_days_late > 15 AND i.invoice_days_late <= 30, i.invoice_balance, 0)), 0) as late_16_to_30, IFNULL(SUM(IF(i.invoice_days_late > 30 AND i.invoice_days_late <= 60, i.invoice_balance, 0)), 0) as late_31_to_60, IFNULL(SUM(IF(i.invoice_days_late > 60, i.invoice_balance, 0)), 0) as late_61_plus, IFNULL(c.credits_total, 0) as credits_total, IFNULL(c.credits_with_balance, 0) as credits_with_balance, IFNULL(c.credits_no_balance, 0) as credits_no_balance FROM ckv_invoice_aging i, (SELECT SUM(up.unapplied_amount) as credits_total, SUM(IF(i.customers_id IS NOT NULL, up.unapplied_amount, 0)) as credits_with_balance, SUM(IF(i.customers_id IS NULL, up.unapplied_amount, 0)) as credits_no_balance FROM ckv_unapplied_payments up LEFT JOIN (SELECT DISTINCT customer_id as customers_id FROM acc_invoices WHERE paid_in_full = 0) i ON up.customers_id = i.customers_id) c');
?>